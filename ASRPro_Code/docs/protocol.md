# ASR Pro - STM32 通信协议

本文档定义了ASR Pro语音识别模块(ESP32)与曼波机器狗主控板(STM32)之间的串口通信协议。

## 1. 物理层

- **接口**: UART (通用异步收发传输器)
- **波特率**: `9600` bps
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无
- **电平**: TTL (3.3V)

## 2. 协议格式

本协议采用简单的 **单字符命令** 格式，由ESP32作为发送方，STM32作为接收方。

- **方向**: ESP32 -> STM32
- **格式**: 单个ASCII字符
- **特点**: 实现简单，响应快速，适用于低带宽、低复杂度的控制场景。

## 3. 命令定义

下表列出了所有支持的命令及其功能描述。

### 运动控制命令

| 命令字符 | 宏定义 (ESP32) | 功能描述 |
|:---:|:---|:---|
| `'f'` | `CMD_FORWARD` | 机器狗前进 |
| `'b'` | `CMD_BACKWARD` | 机器狗后退 |
| `'l'` | `CMD_TURN_LEFT` | 机器狗左转 |
| `'r'` | `CMD_TURN_RIGHT` | 机器狗右转 |
| `'5'` | `CMD_STOP` | 机器狗停止运动 |

### 姿态控制命令

| 命令字符 | 宏定义 (ESP32) | 功能描述 |
|:---:|:---|:---|
| `'1'` | `CMD_STAND` | 站立姿态 |
| `'3'` | `CMD_SIT` | 坐下姿态 |
| `'p'` | `CMD_LIE` | 趴下姿态 |
| `'d'` | `CMD_DANCE` | 跳舞动作 |

### 交互与模式命令

| 命令字符 | 宏定义 (ESP32) | 功能描述 |
|:---:|:---|:---|
| `'s'` | `CMD_SHAKE_HAND` | 握手动作 |
| `'o'` | `CMD_HELLO` | 打招呼动作 |
| `'Z'` | `CMD_STATUS` | 查询当前状态 (预留) |
| `'x'` | `CMD_ULTRASONIC_ON` | 开启超声波避障模式 |
| `'c'` | `CMD_ULTRASONIC_OFF`| 关闭超声波避障模式 |
| `'H'` | `CMD_INFRARED_ON` | 开启红外避障模式 |
| `'h'` | `CMD_INFRARED_OFF`| 关闭红外避障模式 |

## 4. 工作流程

1.  **语音识别**: ESP32上的ASR Pro模块识别到用户语音指令。
2.  **ID匹配**: ESP32在`g_CommandMap`命令映射表中查找对应的语音识别ID (`snid`)。
3.  **命令编码**: 找到匹配项后，获取对应的单字符命令。
4.  **串口发送**: ESP32通过`Serial2.print(cmd)`将命令字符发送给STM32。
5.  **命令接收**: STM32的`USART3`接收到字符。
6.  **动作执行**: STM32根据接收到的字符，调用相应的函数执行机器狗的动作。

## 5. 协议扩展

如果需要增加新的命令，请遵循以下步骤：

1.  **STM32端**: 在STM32的`main.c`或`usart3.c`中，为新的命令字符添加`case`分支和对应的处理函数。
2.  **ESP32端**: 
    - 在`ASRPro_Code/include/commands.h`中为新命令定义一个`CMD_`宏。
    - 在`ASRPro_Code/src/commands.cpp`的`g_CommandMap`表中，添加新的语音识别ID和命令字符的映射关系。
3.  **文档更新**: 及时更新本协议文档，确保软硬件两端和文档保持同步。
