# 毕业设计(论文)

---

**题目**: 基于STM32的智能四足机器狗设计与实现

**班级、专业**: [待填写]

**学号**: [待填写]

**学生**: [待填写]

**指导教师**: [待填写]

**起止日期**: [待填写]

---

# 摘要

本文详细阐述了一款基于STM32微控制器的智能四足机器狗——"小呆"的设计与实现全过程。该设计旨在打造一个集灵活运动、自主感知与丰富交互能力于一体的桌面级电子宠物。硬件系统以STM32F103C8T6为控制核心,整合了8路舵机驱动系统、超声波与红外传感器组成的感知系统、蓝牙与语音模块构成的通信系统,以及OLED显示屏等关键模块。软件系统基于Keil MDK开发环境,采用C语言编写。运动控制方面,设计并实现了一套基于对角步态的平滑协调控制算法;环境感知方面,提出了一种基于行为分级的多传感器融合策略,有效实现了自主避障与防跌落功能;人机交互方面,构建了涵盖蓝牙APP、语音指令、语音合成及OLED表情显示的立体化交互体系,并通过引入"体力值"等内部状态管理系统,显著提升了机器狗的"生命感"和交互趣味性。系统测试结果表明,该机器狗在运动稳定性、环境适应性、指令响应及续航能力等方面均达到了设计预期,验证了方案的可行性与创新性。

**关键词**: STM32单片机; 四足机器人; 传感器融合; 语音交互; 人机交互

---

# 目录

- 第一章 引言
  - 1.1 研究背景与意义
  - 1.2 国内外研究现状
  - 1.3 主要研究内容
  - 1.4 论文组织结构
- 第二章 系统总体设计
  - 2.1 设计目标与功能需求
  - 2.2 系统总体架构
  - 2.3 技术路线
  - 2.4 关键技术分析
- 第三章 硬件系统设计
  - 3.1 主控制器选型与设计
  - 3.2 执行机构设计
  - 3.3 传感器系统设计
  - 3.4 通信模块设计
  - 3.5 显示与反馈系统
  - 3.6 电源系统设计
- 第四章 软件系统设计
  - 4.1 软件开发环境
  - 4.2 系统初始化
  - 4.3 舵机控制模块
  - 4.4 运动控制算法
  - 4.5 传感器数据处理
  - 4.6 避障与导航算法
  - 4.7 通信协议设计
  - 4.8 状态管理系统
  - 4.9 主程序流程
- 第五章 关键技术实现
  - 5.1 舵机协调控制技术
  - 5.2 多传感器融合避障
  - 5.3 语音交互实现
  - 5.4 智能状态管理
  - 5.5 OLED表情显示
- 第六章 系统测试与分析
  - 6.1 硬件测试
  - 6.2 软件功能测试
  - 6.3 系统集成测试
  - 6.4 性能分析
- 第七章 总结与展望
  - 7.1 工作总结
  - 7.2 存在的问题与不足
  - 7.3 未来展望
- 致谢
- 参考文献

---

# 第一章 引言

## 1.1 研究背景与意义

随着科学技术的飞速发展,机器人技术作为一门集机械工程、电子技术、计算机科学、控制理论和人工智能等多学科于一体的综合性学科,正以前所未有的深度和广度改变着人们的生产和生活方式。在众多机器人类型中,四足机器人以其独特的运动模式和对非结构化环境的卓越适应性,成为了机器人领域的研究热点。

四足动物在自然界中经过数亿年的进化,其运动系统展现出高效、稳定和灵活的特点,能够在崎岖不平的地形中自如行走、奔跑和跳跃。仿生四足机器人的研究,正是希望借鉴这些生物优势,开发出能够在复杂环境中替代人类执行任务的机器人系统。从早期的机械连杆结构到如今由先进算法驱动的智能体,四足机器人的发展历程反映了人类对自然运动机理认识的不断深化和工程实现能力的持续突破。

与传统的轮式或履带式机器人相比,四足机器人具有以下显著优势。首先是地形适应性强,通过离散的足式支撑,四足机器人能够跨越障碍物、在崎岖地面上保持稳定,适应楼梯、废墟、野外等多种复杂地形。其次是运动灵活性高,多自由度的腿部结构使得四足机器人能够实现前进、后退、转向、横移、爬升等多种运动姿态,甚至完成跳跃、翻滚等高难度动作。此外,相较于双足机器人,四足机器人具有更稳定的静态和动态平衡能力,能够承载更重的负载,为搭载各类传感器、机械臂等作业工具提供了平台基础。

因此,四足机器人在军事侦察、反恐防爆、抢险救灾、物流运输、管线巡检、家庭服务等领域展现出巨大的应用潜力。开发一款智能化的四足机器人,不仅具有重要的学术研究价值,也符合国家在人工智能和高端制造领域的战略发展方向。

本项目旨在设计并实现一款名为"小呆"的智能交互式桌面机器宠物。它不仅是传统四足机器人技术的缩影,更在人机交互方面进行了积极探索。通过集成蓝牙通信、语音识别、语音合成和OLED表情显示等多种交互方式,我们将一个冰冷的机械装置转变为一个能够与人进行情感交流的"伙伴"。这对于推动服务机器人的发展,提升用户体验,以及探索机器人的社会角色具有重要的实践意义。

## 1.2 国内外研究现状

四足机器人的研究最早可以追溯到20世纪末,经过几十年的发展,已经取得了丰硕的成果。国内外众多高校、研究机构和科技公司纷纷投入研发,推出了一系列具有代表性的四足机器人平台。

在四足机器人领域,国外研究一直处于领先地位。其中,最为人熟知的当属波士顿动力公司(Boston Dynamics)。其开发的Spot机器狗以其卓越的运动性能和对复杂环境的适应能力,成为了四足机器人商业化的典范。Spot能够在建筑工地、矿山、核电站等危险环境中执行巡检和数据采集任务,展现了四足机器人的巨大应用价值。另一家在机器宠物领域取得巨大成功的公司是索尼(Sony)。其AIBO系列机器狗自1999年首次亮相以来,就以其可爱的外观和丰富的交互功能赢得了全球消费者的喜爱。AIBO集成了先进的人工智能和传感器技术,能够识别主人、理解语音指令,并表现出喜怒哀乐等"情感",是机器宠物商业化的成功案例。

此外,麻省理工学院(MIT)的Cheetah系列机器人在运动速度和能效方面取得了突破性进展,其开发的Mini Cheetah更是一款完全由电机驱动的高性能开源四足机器人,极大地推动了学术界的研究。瑞士苏黎世联邦理工学院(ETH Zurich)的ANYmal机器人则在模块化设计和复杂地形适应性方面表现出色,被广泛应用于工业巡检和科研探索。

近年来,国内在四足机器人领域也涌现出一批优秀的企业和研究团队,技术水平和产品化能力快速提升。宇树科技(Unitree Robotics)是国内四足机器人领域的领军企业之一。其推出的Go1、A1等多款机器狗产品,以其高性价比和出色的运动性能,在全球范围内获得了广泛关注。这些产品不仅被用于科研和教育,也开始进入家庭,成为人们的智能玩伴和生活助手。在学术界,清华大学、浙江大学、哈尔滨工业大学等高校也在四足机器人领域进行了深入研究,在步态规划、动态控制、环境感知等方面取得了丰硕的成果。同时,国内也出现了许多优秀的开源四足机器人项目,为广大爱好者和开发者提供了学习和交流的平台。

总体来看,四足机器人技术正朝着更智能、更敏捷、更轻量化、成本更低的方向发展。电机驱动凭借其控制精度和清洁环保的优势,正逐渐成为中小型四足机器人的主流选择。而人机交互技术的不断融入,也使得四足机器人不再仅仅是工具,而开始扮演起"伙伴"和"助手"的角色。

## 1.3 主要研究内容

本项目旨在结合曼波机器狗的现有资料,设计并实现一款功能完整、交互体验良好的智能四足机器狗。主要研究内容包括:

首先是硬件系统设计。在分析曼波机器狗硬件方案的基础上,完成主控模块、驱动模块、传感器模块、通信模块和显示模块的选型与设计,并绘制详细的电路连接图。其次是软件控制算法。基于STM32平台,编写底层驱动程序,实现对舵机、传感器、通信模块等的精确控制。重点研究四足机器人的运动控制算法,包括步态规划、姿态解算等。第三是传感器应用与信息融合。研究超声波传感器和红外传感器在避障和边缘检测中的应用,并探索多传感器信息融合策略,以提高机器狗对环境的感知能力。最后是人机交互实现。通过蓝牙、语音、OLED显示等多种方式,构建一个立体的人机交互系统,实现手机APP控制、语音指令控制、状态反馈等功能,提升用户体验。

## 1.4 论文组织结构

本论文共分为七章,各章内容安排如下。第一章为引言,介绍本课题的研究背景、意义以及国内外研究现状,并明确主要研究内容和论文的组织结构。第二章为系统总体设计,阐述系统的设计目标、功能需求,并给出硬件和软件的总体架构方案。第三章为硬件系统设计,详细介绍各硬件模块的选型、设计和电路实现。第四章为软件系统设计,详细阐述软件开发环境、系统初始化流程、各功能模块的软件实现和核心算法。第五章为关键技术实现,重点讨论舵机协调控制、多传感器融合避障、语音交互等关键技术的实现细节和难点。第六章为系统测试与分析,对搭建的系统进行硬件、软件和整机测试,并对测试结果进行分析。第七章为总结与展望,对全文工作进行总结,指出当前系统的不足,并对未来的改进方向进行展望。

---

# 第二章 系统总体设计

## 2.1 设计目标与功能需求

本项目旨在设计并实现一款名为"小呆"的智能四足机器狗,它不仅是一个能够模拟生物形态进行运动的机器人平台,更是一个具备基础智能和丰富交互能力的桌面级电子宠物。设计的核心目标是,在有限的成本和硬件资源下,构建一个稳定、可靠且具有良好用户体验的嵌入式系统。

在设计目标方面,首先要实现运动控制的灵活性与稳定性,实现机器狗的多姿态运动控制,包括前进、后退、左转、右转等基本步态,以及站立、坐下、趴下等静态姿势。运动过程应力求平顺、自然,并能在桌面等平坦环境中保持稳定。其次要赋予环境感知的自主性,使其能够利用传感器自主规避障碍物和防止从桌边跌落,提高其在未知环境中的生存能力。第三要建立人机交互的友好性与多样性,用户可以通过手机APP、语音指令等多种方式对机器狗进行控制和互动。同时,机器狗应能通过OLED屏幕和语音合成模块给予及时的状态和情感反馈。最后要保证系统的模块化与可扩展性,整体系统采用模块化设计思想,无论是硬件连接还是软件架构,都应清晰明了,便于后续的功能升级和二次开发。

为了达成上述设计目标,系统需要满足以下具体的功能需求。在基本运动方面,要实现前进、后退、左转、右转等基本步态,运动速度可调,转向灵活。在姿态控制方面,要实现站立、坐下、趴下等多种静态姿势,姿态切换平稳,无明显抖动。在自主避障方面,要利用超声波传感器检测前方障碍物并自主规避,检测距离不小于10cm,能有效绕开障碍物。在边缘检测方面,要利用红外传感器检测桌面边缘防止跌落,能够可靠检测8-10cm高度的边缘。在蓝牙控制方面,要通过手机APP蓝牙连接控制机器狗运动和行为,连接稳定,延迟低,控制指令可靠传输。在语音控制方面,要通过语音识别模块识别特定指令词控制机器狗,识别特定中文指令如"前进"、"坐下"等。在语音反馈方面,要通过语音合成模块播报当前状态或执行的动作,语音清晰自然,能够表达欢迎、执行指令等内容。在表情显示方面,要通过OLED屏幕显示不同的像素眼部表情表达情感,能够显示立正、睡觉、难受等多种表情。在状态管理方面,要内置"体力值"和"开心值"等虚拟状态影响行为逻辑,体力值耗尽后限制部分功能,增加交互趣味性。

## 2.2 系统总体架构

为了高效、可靠地实现上述功能需求,本系统在设计上遵循了分层和模块化的原则,将复杂的系统分解为硬件层、驱动层、应用层和交互层,各层之间既相互独立又紧密协作。

系统总体架构清晰地展示了系统的核心组成部分以及各模块之间的信息流和控制流关系。STM32主控制器作为整个系统的大脑,负责处理所有传感器输入、执行控制算法,并驱动执行机构和交互设备。

硬件系统是机器狗实现一切功能的基础。本系统的硬件架构围绕STM32F103C8T6主控制器构建,分为控制、感知、执行、交互和电源五个核心部分。控制核心采用意法半导体(ST)公司的STM32F103C8T6单片机,它基于ARM Cortex-M3内核,具有高性能、低功耗和丰富外设接口的特点,足以满足本系统对多路PWM输出、多串口通信和传感器数据处理的需求。感知系统由超声波传感器和红外传感器组成,超声波传感器用于远距离障碍物检测,红外传感器则用于近距离的边缘检测,二者结合为机器狗提供了可靠的环境感知能力。执行系统主要由8个舵机组成,分别控制四条腿的两个关节,实现机器狗的运动。舵机由STM32的PWM信号直接驱动,结构简单,控制方便。交互系统包括蓝牙模块、语音识别模块、语音合成模块和OLED显示屏,这些模块通过串口(UART)与主控连接,实现了多样化的人机交互通道。电源系统采用锂电池供电,通过相应的电源管理电路为各个模块提供稳定、可靠的电能。

软件系统是机器狗的灵魂,负责将硬件功能有机地组织起来,实现复杂的控制逻辑和智能行为。软件架构同样采用分层设计,分为底层驱动、中间层服务和顶层应用三层。底层驱动直接与硬件交互,负责初始化和配置STM32的片上外设,如GPIO、TIM(定时器)、UART等,并为上层提供标准化的硬件访问接口。例如,封装PWM输出函数以控制舵机角度,封装串口收发函数以处理通信数据。中间层服务基于底层驱动,实现对具体功能模块的控制,如运动学解算、步态规划、传感器数据解析、通信协议处理等,该层是连接底层硬件和上层应用逻辑的桥梁。顶层应用是系统功能的最终实现层,它通过一个主循环不断检测外部输入(如蓝牙指令、语音指令)和内部状态(如传感器数据、体力值),并根据预设的逻辑进行决策,调用中间层服务来完成相应的动作和交互,如执行前进指令、触发避障行为、切换OLED表情等。

## 2.3 技术路线

本项目的技术路线旨在选择成熟、可靠且符合项目需求的技术方案,以确保项目的顺利实施。主控平台选用基于ARM Cortex-M3内核的STM32系列单片机,并使用Keil MDK作为集成开发环境,采用C语言进行编程。开发过程中充分利用STM32标准外设库,以简化开发流程,提高代码的可移植性。

运动控制采用基于脉冲宽度调制(PWM)的舵机直驱方案。通过STM32的通用定时器产生多路PWM信号,直接控制舵机转动到指定角度。步态规划采用预定义时序的方式,通过精确控制每条腿在不同时刻的抬起和落下,形成稳定协调的步态。

环境感知采用主动式传感器方案。超声波传感器通过发送和接收声波的时间差来计算距离,红外传感器通过检测红外光的反射情况来判断是否存在障碍物或边缘。这两种传感器技术成熟,易于使用,且能满足基本的避障和防跌落需求。

人机交互方面,通信方面蓝牙和语音模块均通过串口与主控连接,采用自定义的通信协议进行数据交换。显示方面,OLED屏幕通过I2C或SPI协议与主控连接,通过调用图形库函数来显示预设的像素图像。

系统集成与测试采用自底向上的集成方法。首先完成各硬件模块的独立测试,确保其功能正常;然后编写底层驱动和中间层服务,并进行单元测试;最后开发顶层应用逻辑,将所有模块联调,进行系统级的功能和性能测试。

## 2.4 关键技术分析

要成功实现本设计,需要解决以下几个关键技术问题。

首先是多舵机协调与步态规划。四足机器人的稳定运动依赖于多个舵机的精确协调。如何规划每条腿上两个舵机的运动轨迹,以及四条腿之间的配合时序,是实现平稳步态的核心。这需要对机器人的运动学进行分析,并设计出合理的步态算法。

其次是多传感器信息融合与决策。系统同时拥有超声波和红外两种传感器,它们在检测距离、方向和抗干扰能力上各有优劣。如何有效地结合两者的信息,例如在超声波检测到远处障碍物时减速,在红外检测到脚下边缘时立即停止,是实现可靠避障和防跌落的关键。

第三是实时通信与指令优先级处理。系统需要同时处理来自蓝牙和语音识别模块的控制指令。当两种指令同时到达时,必须有一套明确的优先级处理机制(本项目设定蓝牙优先),以避免控制冲突。此外,整个通信和控制流程必须保证较低的延迟,以提供良好的实时交互体验。

最后是基于状态机的应用逻辑设计。机器狗需要在多种行为模式(如前进、避障、睡觉、互动)之间进行切换。采用状态机(State Machine)的设计思想,可以清晰地描述各种状态以及它们之间的转换条件,使得复杂的应用逻辑更加条理化,易于实现和维护。例如,当体力值低于某个阈值时,系统从"正常"状态切换到"疲劳"状态,其行为模式也会相应改变。

---

# 第三章 硬件系统设计

硬件系统是四足机器狗实现感知、决策和行动的物理基础。本章将详细阐述机器狗硬件系统的设计过程,包括主控制器的选型、执行机构、传感器系统、通信模块、显示与反馈系统以及电源系统的设计与实现。所有设计均以稳定性、低功耗和成本效益为原则,旨在构建一个可靠、高效的硬件平台。

## 3.1 主控制器选型与设计

主控制器是整个机器狗系统的"大脑",负责处理所有输入信号、运行核心控制算法并向下级设备发出指令。因此,选择一款性能合适、接口丰富且稳定可靠的主控制器至关重要。

本项目选用意法半导体(STMicroelectronics)的STM32F103C8T6作为主控制器。该芯片属于STM32F1系列中的主流型产品,基于ARM Cortex-M3内核,工作频率最高可达72MHz,内置64KB的Flash存储器和20KB的SRAM。选择该芯片主要基于以下几点考虑。

首先是强大的性能。72MHz的主频和32位的Cortex-M3内核提供了充足的计算能力,能够胜任本设计中涉及的运动学解算、传感器数据处理和多任务协调等要求。其次是丰富的外设接口。STM32F103C8T6拥有多个通用定时器(TIM)、通用同步/异步收发器(USART)、I2C、SPI等接口。本项目需要至少8路PWM信号来驱动舵机,3个串口分别用于蓝牙、语音识别和语音合成模块,1个I2C或SPI接口用于驱动OLED屏幕,这些需求该芯片均能满足。第三是良好的开发生态。STM32系列拥有庞大的用户群体和丰富的开源资料,开发工具链成熟(如Keil MDK、STM32CubeMX),官方提供了完善的标准外设库(Standard Peripherals Library)和HAL库,极大地降低了开发难度,方便了代码的编写与调试。最后是高性价比。该芯片在保证性能的同时,价格相对低廉,符合本项目的成本控制要求。

为了保证STM32F103C8T6能够正常工作,需要为其搭建一个最小系统,主要包括电源电路、时钟电路和复位电路。电源电路采用3.3V LDO(低压差线性稳压器)将输入的5V电压转换为3.3V,为单片机及大部分外设供电。同时,在电源引脚附近配置多个去耦电容(如100nF和10uF),以滤除电源噪声,保证系统稳定运行。时钟电路外部连接一个8MHz的无源晶振作为高速外部时钟(HSE),通过内部锁相环(PLL)倍频至72MHz作为系统主时钟。同时连接一个32.768KHz的晶振作为低速外部时钟(LSE),供RTC(实时时钟)使用。复位电路采用按键和阻容组合的低电平复位方式,确保单片机可以手动复位。

在最小系统的基础上,根据各模块的功能需求,对芯片的GPIO引脚进行合理规划和分配。例如PA0-PA7用于8个舵机的PWM信号输出,PA9和PA10用于蓝牙模块的串口通信,PA2和PA3用于语音合成模块的串口通信,PB10和PB11用于语音识别模块的串口通信,PB6和PB7用于OLED显示屏的I2C通信,PB12和PB13用于超声波传感器的触发和回波信号,PB1-PB4用于4个红外传感器的输入,PC13用于LED状态指示灯的输出。

## 3.2 执行机构设计

执行机构是机器狗运动能力的直接体现,由8个舵机及其连接的腿部结构件组成。

舵机是一种集成了直流电机、减速齿轮组和控制电路的位置伺服单元。本项目选用常见的SG90微型舵机,其工作电压为4.8V-6V,扭矩约为1.8kg/cm,重量仅为9g。选择SG90的原因是其体积小、重量轻、价格便宜,且控制简单,非常适合用于制作桌面级的轻型机器狗。

舵机的控制是通过PWM信号实现的。PWM信号的周期通常为20ms (50Hz),通过调节脉冲宽度(高电平时间)来控制舵机转动到特定角度。对于SG90舵机,脉冲宽度与角度的对应关系大致为:0.5ms对应0度,1.5ms对应90度(中位),2.5ms对应180度。STM32的通用定时器和高级定时器都具有PWM输出功能。通过配置定时器的预分频器(PSC)和自动重装载寄存器(ARR)可以设定PWM的周期,通过配置捕获/比较寄存器(CCR)可以设定脉冲宽度,从而实现对舵机角度的精确控制。

本机器狗采用四条腿的结构,每条腿由两个舵机驱动,分别控制"大腿"和"小腿"的关节,构成一个二自由度的串联连杆机构。8个舵机的布局中,4个舵机(Hip)控制腿在水平面内的摆动,另外4个舵机(Knee)控制膝关节的屈伸。通过运动学正解,可以根据两个关节的角度计算出足底末端相对于身体的坐标。反之,通过运动学逆解,可以根据期望的足底末端轨迹,反向计算出每个关节需要转动的角度。在本项目中,为了简化控制,我们没有进行复杂的实时逆解运算,而是采用预定义步态轨迹的方法。即预先设定好一组关键角度序列,通过控制舵机按顺序运动到这些角度,从而组合成前进、后退等动作。这种方法虽然灵活性稍差,但实现简单,资源消耗小,足以满足基本运动需求。

## 3.3 传感器系统设计

传感器系统是机器狗感知外部世界的"五官",为自主行为提供决策依据。

本项目选用HC-SR04超声波模块进行距离测量。其工作原理如下:主控向Trig引脚发送一个至少10μs的高电平信号触发模块发送超声波,模块自动发送8个40kHz的方波并开始计时,当模块接收到返回的超声波时Echo引脚会输出一个高电平,高电平持续的时间即为超声波从发送到返回的总时间,根据公式"距离=(高电平时间×声速)/2"即可计算出障碍物的距离,其中声速约为340m/s。在电路连接上,Trig和Echo引脚分别连接到STM32的两个GPIO口。通过一个定时器来精确测量Echo引脚的高电平时间,从而计算出距离,为自主避障提供数据支持。

为了防止机器狗从桌子边缘跌落,我们在机器狗的底部前、后、左、右四个方向各安装了一个红外避障传感器。这种传感器集成了一对红外发射管和接收管。其工作原理是:发射管发出红外光,如果遇到障碍物(如地面),红外光被反射回来并被接收管接收,传感器输出低电平;如果没有遇到障碍物(如到达桌子边缘),接收管接收不到反射信号,传感器输出高电平。通过检测这四个传感器的电平状态,即可判断机器狗是否处于危险的边缘位置。例如,当前方红外传感器输出高电平时,说明前方已是悬崖,应立即停止前进。四个传感器的输出信号直接连接到STM32的四个GPIO输入引脚,程序通过轮询这些引脚的电平状态来实现边缘检测功能。

## 3.4 通信模块设计

通信模块是实现人机交互的关键,提供了远程控制和语音交互的能力。

选用HC-05或HC-06等通用蓝牙转串口模块。这类模块使用简单,能将蓝牙无线通信转换为TTL电平的串口数据。模块的TXD和RXD引脚与STM32的USART1(PA9, PA10)交叉连接。手机APP通过蓝牙发送控制指令(如字符'F'代表前进),模块接收到后通过串口发送给STM32。STM32的串口接收中断程序在接收到数据后,解析指令并执行相应动作。这种方式实现了简单可靠的无线遥控功能。

采用离线式语音识别模块,如SU-03T。这类模块通常预先烧录了特定的指令词,当识别到匹配的语音时,会通过串口发送对应的编号或字符。模块的串口与STM32的USART3(PB10, PB11)连接。例如,当用户说出"前进"时,模块可能通过串口发送字符'F'。STM32接收到后即可执行前进动作。离线识别的优点是不依赖网络,响应速度快,但识别的词条固定,灵活性稍差。

采用SYN6288中文语音合成芯片。该芯片能将文本(GB2312、GBK或Unicode编码)合成为清晰、自然的中文语音。通过向芯片发送特定格式的文本数据帧,即可控制其播报内容、语速、音量和背景音乐。芯片的串口与STM32的USART2(PA2, PA3)连接。例如,在开机时,STM32可以发送"旺旺"的文本数据,芯片即可合成狗叫声,增加了机器狗的趣味性和交互的生动性。

## 3.5 显示与反馈系统

为了让交互更加直观和富有趣味性,系统设计了OLED屏幕和LED指示灯。

选用一块0.96英寸、分辨率为128x64的单色OLED屏幕。该屏幕具有自发光、对比度高、体积小、功耗低等优点。通过I2C接口(PB6, PB7)与STM32连接。通过调用图形库函数,可以在屏幕上显示预先设计好的像素眼部表情,如立正、睡觉、难受等,从而直观地反馈机器狗的当前状态和"情绪"。

在STM32的PC13引脚上连接了一个LED灯,可用于指示系统的工作状态,如闪烁表示系统正常运行,常亮或熄灭表示特定模式,为调试和状态判断提供了便利。

## 3.6 电源系统设计

一个稳定可靠的电源系统是整机正常运行的根本保障。考虑到舵机在启动和运动时会有较大的瞬时电流,电源系统必须有足够的驱动能力。

选用两节18650锂电池串联(7.4V)或航模锂电池组作为主电源,以提供足够的电压和容量,保证较长的续航时间。7.4V的电池电压需要经过降压处理才能供给各个模块。其中,8个舵机的供电需要一个能够提供较大电流(如3A以上)的5V-6V稳压模块(如LM2596 DC-DC降压模块)。而STM32主控、传感器和通信模块等则需要一个3.3V的LDO稳压器从5V转压后供电。通过分路供电,可以避免舵机的大电流对主控及其他逻辑电路造成干扰。

通过以上精心设计,构建了一个功能全面、层次清晰的硬件系统,为后续的软件开发和功能实现奠定了坚实的基础。

---

# 第四章 软件系统设计

如果说硬件系统是四足机器狗的骨骼和感官,那么软件系统就是其灵魂和智慧的源泉。本章将深入探讨机器狗软件系统的设计与实现,内容涵盖开发环境的搭建、系统初始化流程、核心功能模块(包括舵机控制、运动算法、传感器处理、通信协议、状态管理)的实现,以及主程序的整体逻辑。本设计旨在构建一个结构清晰、逻辑严谨、运行高效且易于扩展的嵌入式软件系统。

## 4.1 软件开发环境

选择合适的开发工具是项目成功的一半。一个高效的集成开发环境(IDE)和完善的软件库能够极大地提升开发效率和代码质量。

本项目采用Keil MDK (Microcontroller Development Kit)作为主要的开发环境。Keil MDK是ARM公司官方推荐的开发工具,专为基于ARM Cortex-M系列内核的微控制器设计。它集成了功能强大的μVision IDE、ARM C/C++编译器、调试器(支持J-Link、ST-Link等)和包管理器,提供了一个从代码编写、编译、烧录到在线调试的一站式解决方案。

为了简化底层硬件操作,本项目基于STM32F1xx标准外设库(Standard Peripherals Library, SPL)进行开发。与直接操作寄存器相比,标准外设库将底层硬件操作封装成了标准化的API函数,开发者只需调用这些函数即可完成对GPIO、TIM、USART等外设的配置和使用。这不仅降低了开发难度,也增强了代码的可读性和可移植性。

使用Keil MDK内置的ARM Compiler进行代码编译和链接,生成可执行的HEX或BIN文件。通过ST-Link或J-Link等硬件调试器,将编译好的程序下载到STM32F103C8T6芯片的Flash中。同时,这些调试器也支持硬件在线调试(In-Circuit Debugging),可以设置断点、单步执行、查看内存和变量值,是解决复杂问题的利器。

## 4.2 系统初始化

系统上电后,主程序首先需要执行一系列初始化操作,为后续程序的正常运行做好准备。这个过程就像建房子打地基,其正确性和完备性至关重要。初始化流程主要包括系统时钟配置和各外设模块的初始化。

系统时钟配置是所有外设初始化的前提。通过SystemInit()函数,将外部8MHz晶振(HSE)通过PLL倍频到72MHz,作为系统主时钟。同时,为APB1和APB2总线上的外设(如USART、TIM、GPIO)使能时钟。

GPIO初始化配置所有用到的GPIO引脚的工作模式。例如,用于LED的引脚配置为推挽输出模式,用于红外传感器的引脚配置为浮空输入或上拉输入模式,用于串口和PWM的引脚则需要配置为相应的复用功能模式。

定时器(TIM)初始化在本项目中扮演着核心角色。需要初始化一个高级或通用定时器用于产生8路PWM信号以控制舵机。配置其预分频器(PSC)和自动重装载寄存器(ARR)以得到50Hz的周期,并使能相应的PWM输出通道。

串口(USART)初始化需要初始化三个串口,分别配置它们的波特率(如9600bps)、数据位、停止位、校验位,并使能接收中断(RXNEIE),以便在接收到数据时能立即响应,避免数据丢失。

中断控制器(NVIC)配置为已使能的串口接收中断等设置中断优先级,并使能中断通道。合理的优先级配置可以确保关键任务(如运动控制)的实时性不受影响。

其他模块初始化调用OLED、超声波、红外等模块各自的初始化函数,完成其内部参数和工作模式的设置。

## 4.3 舵机控制模块

舵机控制是实现机器狗所有动作的基础。该模块的核心任务是将上层应用期望的关节角度,精确地转换为底层硬件所需的PWM信号。

如前所述,舵机的角度由PWM信号的脉冲宽度决定。在STM32中,这通过修改定时器捕获/比较寄存器(CCR)的值来实现。首先,需要建立角度与CCR值之间的映射关系。假设定时器时钟频率为72MHz,PWM周期为20ms (50Hz),预分频器值PSC=7200-1,自动重装载值ARR=2000-1,此时定时器计数一次的时间为(7200/72,000,000)s=0.1ms。PWM的脉宽范围为0.1ms×CCR。根据SG90舵机的特性(0.5ms-2.5ms对应0-180度),可以推导出CCR值与角度(angle)的转换公式。通过一个函数封装这个转换过程,上层应用只需传入期望的角度值,该函数即可自动计算并更新对应通道的CCR寄存器值,从而驱动舵机转到指定位置。

机器狗的动作需要多个舵机协同完成。如果让所有舵机瞬间从当前角度转到目标角度,会导致动作僵硬、冲击大,甚至可能因瞬时电流过大而导致系统掉电。因此,必须实现平滑控制。一种简单有效的平滑控制方法是线性插值。假设舵机要用时t从角度A转到角度B,可以将这个过程分解为N个小步骤。每个步骤舵机转动一小段角度Δangle=(B-A)/N,每一步之间延迟一小段时间Δt=t/N。这样,舵机的运动就变得平滑连续。在实现多舵机动作组(如"站立")时,可以为每个舵机设定目标角度和运动时间,然后在一个循环中同步更新所有舵机的角度,从而实现多关节的协调运动。

## 4.4 运动控制算法

运动控制算法是机器狗软件系统的核心,它定义了机器狗如何行走、转向和变换姿态。本项目采用基于预定义步态的控制策略。

四足动物的行走是一个复杂的协调过程。为了简化实现,本项目采用经典的对角步态(Trot)。在对角步态中,对角线上的两条腿(如左前腿和右后腿)为一组,同步抬起和落下,而另外一组对角腿则作为支撑。一个完整的前进步态周期可以分解为以下几个阶段:身体前倾,身体重心略微前移为抬腿做准备;抬起A组腿,左前腿和右后腿同时抬起并向前摆动;身体前进,依靠支撑的B组腿(右前腿和左后腿)蹬地推动身体前进;落下A组腿,A组腿完成前摆并落地成为新的支撑腿;抬起B组腿,右前腿和左后腿同时抬起并向前摆动;身体前进,依靠支撑的A组腿蹬地推动身体前进;落下B组腿,B组腿完成前摆并落地。后退、左转、右转等动作也可以通过类似的步态分解来实现。例如,左转时,可以让左侧的两条腿摆动幅度小于右侧的两条腿,从而产生转向力矩。

站立、坐下、趴下等姿态是通过将8个舵机设置到一组预定义的角度来实现的。这些角度值需要根据机器狗的机械结构精确校准。例如站立姿态时所有大腿舵机设置在90度(与身体垂直),所有小腿舵机也设置在90度(与大腿垂直),使身体被平稳抬起。坐下姿态时前腿保持站立姿态,后腿的大腿和小腿舵机协同动作,使身体后半部分降低并接触地面。姿态之间的切换同样需要使用平滑控制,通过插值算法让机器狗缓慢而自然地完成动作,而不是瞬间"跳变"。

## 4.5 传感器数据处理

传感器是机器狗的眼睛和耳朵,其数据的准确处理是实现智能行为的前提。

超声波数据处理通过定时器的输入捕获功能,精确测量HC-SR04模块Echo引脚输出的高电平脉冲宽度。得到时间t(单位:微秒)后,根据公式"距离(cm)=t×0.034/2"计算出距离。为了减少单个测量误差,可以采用滑动平均滤波的方法,即连续测量多次(如5次),去掉一个最大值和一个最小值,然后取剩余值的平均值作为最终的测量结果。

红外信号处理相对简单,红外传感器的输出是数字信号(高/低电平)。程序只需通过GPIO_ReadInputDataBit()函数定期读取连接到4个红外传感器的GPIO引脚的电平即可。为了防止因传感器抖动或环境光干扰造成的误判,可以增加一个简单的软件滤波:只有当连续两次或三次读取到相同的电平状态时,才确认其状态发生了改变。

## 4.6 避障与导航算法

基于处理后的传感器数据,系统可以实现基本的自主避障和防跌落功能。

避障逻辑在主循环中定期调用超声波测距函数。如果机器狗处于前进状态,且前方距离小于设定的阈值(如15cm),则立即停止前进,并执行一个预设的避障动作,例如后退一小步然后左转90度再继续尝试前进。这是一个简单的"反应式"避障策略。

边缘检测逻辑同样在主循环中实时监测底部4个红外传感器的状态。任何一个传感器检测到边缘(输出高电平),都应立即触发最高优先级的制动操作,停止所有运动防止跌落。例如,如果左前方的红外传感器触发,机器狗应立即停止并执行后退和右转的组合动作,以远离危险区域。

## 4.7 通信协议设计

为了规范手机APP、语音模块与主控之间的通信,需要设计一个简单明确的通信协议。本项目采用单字符指令的协议。例如字符'F'代表前进,'B'代表后退,'L'代表左转,'R'代表右转,'S'代表停止,'1'代表站立,'2'代表睡觉(卧),'3'代表坐下,'p'代表睡觉(趴),'o'代表避障模式开,'c'代表避障模式关。

在主控的软件设计中,需要建立一个指令优先级处理机制。系统优先处理蓝牙串口(USART1)的数据,只有当蓝牙没有数据时才去处理语音识别串口(USART3)的数据。这确保了用户通过手机APP进行的手动遥控具有最高的实时性。

## 4.8 状态管理系统

为了让机器狗更像一个"宠物"而不是一个冷冰冰的机器,项目中引入了"体力值"(stamina)和"开心值"(happiness)的虚拟状态管理系统。

体力值系统初始体力值为500。执行前进、后退等运动会消耗体力值,而执行"睡觉"等休息动作则可以恢复体力值。当体力值耗尽(stamina<=0)时,机器狗会进入"难受"模式,拒绝执行大部分运动指令,只响应"睡觉"指令。这个设计增加了交互的真实感和趣味性。

开心值系统初始开心值为200。虽然在当前代码中"开心值"没有直接与机器狗的行为强关联,但它为未来的功能扩展预留了接口。例如,可以设计"抚摸"交互(通过触摸传感器)来增加开心值,当开心值高时机器狗可能会做出一些特殊的"卖萌"动作。

## 4.9 主程序流程

主程序是整个软件系统的中枢,它在一个无限循环(while(1))中运行,负责任务的调度和逻辑的决策。主程序流程包括:系统初始化,在循环开始前完成所有硬件和软件模块的初始化;检查体力值,判断体力值是否大于0,如果体力耗尽则进入特殊处理流程;获取输入,按优先级顺序(蓝牙>语音)获取外部控制指令;检查传感器,读取超声波和红外传感器的值;决策与执行,根据获取的指令和传感器数据结合当前的内部状态(如是否处于避障模式)决定下一步要执行的动作,这里通常使用一个大的switch-case语句来处理不同的move_mode指令;更新状态,根据执行的动作更新体力值、开心值等内部状态;更新显示,在OLED屏幕上显示与当前状态匹配的表情;循环,返回步骤2开始下一次循环。

通过这样的软件设计,我们构建了一个功能完备、逻辑清晰、可扩展性强的嵌入式控制系统,为智能四足机器狗的稳定运行和丰富交互提供了可靠的软件保障。

---

# 第五章 关键技术实现

在前几章中,我们对四足机器狗的总体方案、硬件构成和软件架构进行了宏观设计。本章将聚焦于项目实现过程中的几个核心技术难点,深入剖析其具体实现细节、挑战及解决方案。这些关键技术的突破是确保机器狗从一个静态的硬件集合体转变为一个能够稳定运动、智能交互的"生命体"的根本所在。我们将重点探讨舵机协调控制、多传感器融合避障、语音交互以及智能状态管理等技术的实现过程。

## 5.1 舵机协调控制技术

四足机器人的运动本质上是多个舵机(关节)在时序上的精确协同。如何让8个独立的舵机平滑、同步地运动,形成稳定和谐的步态,是本项目的首要技术挑战。

问题的核心在于,一个动作(如"前进"中的抬腿)需要多个舵机同时启动,并以不同的速度、经过不同的角度范围,最终在同一时刻完成各自的运动。若处理不当,直接向每个舵机发送目标角度指令会导致动作僵硬、冲击大,舵机会以最大速度转动,导致动作瞬时完成,产生巨大的机械冲击和噪音;姿态不稳定,各舵机因转动角度不同完成时间不一,导致在动作过程中身体姿态失衡容易摔倒;瞬时电流过大,8个舵机同时满载启动会产生远超平均水平的峰值电流,极易造成主板电源压降导致单片机复位或系统崩溃。

为了解决这些问题,我们引入了基于时间分割的增量式控制策略,即"角度插值算法"。该算法的基本思想是将一个完整的动作在时间维度上切分成若干个微小的片段(帧),在每个片段内只让舵机转动一小部分角度。通过快速连续地播放这些"帧",宏观上就能看到一个平滑、连续的动作。

算法实现步骤包括:定义动作组,将一个完整的动作(如"站立")定义为一个"动作组(Action Group)",一个动作组包含所有参与该动作的舵机的目标角度和完成该动作所需的总时间;计算增量,在动作开始前计算每个舵机需要转动的总角度delta_angle(目标角度-当前角度);时间分割与插值,设定一个固定的刷新周期例如20ms(与PWM周期一致),根据总时间total_time计算出完成该动作所需的总步数total_steps=total_time/20,然后为每个舵机计算出每一步需要转动的微小角度增量step_angle=delta_angle/total_steps;同步执行,启动一个定时器以20ms的间隔触发中断,在每次中断服务程序中将所有舵机的当前角度加上各自的step_angle并调用PWM控制函数更新所有舵机的CCR寄存器,这个过程持续total_steps次。

通过该算法,我们成功地将之前生硬的瞬时动作优化成了连贯、平滑的运动。在实验中,我们将"站立"动作的时间设置为1秒,刷新周期为20ms,即将整个动作分解为50个步骤。通过示波器观察PWM信号,可以看到脉冲宽度在50个周期内呈线性变化,最终稳定在目标值。从实际效果看,机器狗能够缓慢而平稳地从趴下姿态过渡到站立姿态,整个过程没有明显的抖动和冲击,瞬时电流也得到了有效控制,系统运行稳定。这项技术的实现不仅极大地提升了机器狗运动的美观度和稳定性,也为后续更复杂的动态步态规划(如小跑、跳跃)奠定了坚实的基础。

## 5.2 多传感器融合避障

为了让机器狗具备在未知环境中自主活动的能力,我们为其配备了超声波和红外两种传感器。然而,单一类型的传感器存在其固有的局限性。例如,超声波传感器虽然能探测较远距离,但存在探测盲区和角度限制,且对某些吸音材料不敏感;红外传感器虽然响应快、成本低,但探测距离近,易受环境光和物体颜色影响。因此,将两者信息进行融合,取长补短,是构建一个鲁棒、可靠的避障系统的关键。

超声波传感器(HC-SR04)负责远距离(2cm-400cm)的障碍物预警,我们将它安装在机器狗的"头部"作为前进方向的主要探测手段。红外传感器负责近距离(2cm-30cm)的边缘检测和紧急避障,我们将四个红外传感器分别安装在身体底部的前、后、左、右四个方向,主要用于防止从桌子等高处跌落。

我们的融合策略是一种基于行为分级的决策融合。我们将避障行为根据危险等级分为两个层次:一级警报(预警层)由超声波传感器触发,当机器狗在前进过程中超声波探测到的前方距离小于一个预设的安全阈值(如20cm)时触发一级警报,此时系统并不立即停止而是进入"谨慎前进"模式,降低运动速度并准备执行避障转向;二级警报(危险层)由红外传感器触发,这是最高优先级的警报,当任何一个底部的红外传感器检测到边缘(即接收不到反射信号判断为悬崖)时立即触发二级警报,系统必须无条件、无延迟地停止一切前进或转向动作,并强制执行后退和远离边缘的动作。

通过这套融合策略,机器狗的自主生存能力得到了显著提升。在桌面测试中,当它走向边缘时,底部的红外传感器能够可靠地触发二级警报,使其在距离边缘约5cm处紧急"刹车"并后退,有效避免了跌落。在地面放置障碍物的测试中,当它朝向障碍物前进时,超声波传感器能够提前发出预警,引导其自主转向绕行。实验证明,这种分层决策的融合方法结构简单,计算量小,响应迅速,非常适合在STM32这类资源有限的微控制器上实现,并取得了稳定可靠的避障效果。

## 5.3 语音交互实现

语音交互是提升机器宠物"智能感"和"生命感"的最直接手段。本项目通过集成离线语音识别模块和中文语音合成模块,构建了一个完整的"听"和"说"的交互闭环。

我们选用的离线语音识别模块(如SU-03T)内部固化了声学模型和语言模型,能够独立完成语音到文本的转换并通过串口输出识别结果。其实现流程包括:指令词预设,在模块出厂或配置时预先录入需要识别的中文指令词如"前进"、"后退"、"坐下"、"旺旺"等,并为每个指令词绑定一个唯一的输出代码(如一个特定的十六进制数或ASCII字符);信号采集与处理,模块通过板载麦克风实时采集外界声音并利用内部的DSP芯片进行降噪、端点检测(VAD判断语音的开始和结束)和特征提取(如MFCC特征);模型匹配,将提取到的语音特征与预设的声学模型进行匹配计算出每个指令词的置信度得分;结果输出,选择置信度最高的指令词将其对应的代码通过串口(USART3)发送给STM32主控。STM32端的软件只需在USART3_IRQHandler中断服务程序中接收这个代码并将其作为move_mode变量的值,即可触发相应的动作。

我们采用SYN6288芯片来实现"说"的功能。该芯片的强大之处在于,开发者只需通过串口(USART2)向其发送符合特定帧格式的文本,它就能自动合成为语音并从其音频输出引脚播放出来。我们封装了一个SYN_FrameInfo函数,该函数可以方便地调用语音合成功能。例如在开机时调用SYN_FrameInfo(0, (uint8_t *)"[v12][m0][t5]旺旺"),其中[v12]设置音量,[m0]设置背景音乐,[t5]设置语速,后面的"旺旺"则是要合成的文本。

通过将"听"和"说"结合,我们设计了更自然的交互场景:唤醒与回应,机器狗被语音指令(如"旺旺,你好")唤醒后会立刻播报"我在"并摇摇尾巴给出积极的反馈;指令确认,在执行一个语音指令(如"前进")后可以播报"好的,前进",让用户明确知道指令已被正确识别和执行;状态播报,在特定状态下如体力值过低时可以主动播报"我好累呀,想睡觉了",增加了机器人的"性格"和趣味性。经过测试,离线语音识别在安静环境下识别率较高,响应速度快(小于1秒)。SYN6288合成的中文语音清晰流畅。这套语音交互系统的加入极大地丰富了人机互动的方式,使得"小呆"更像一个能听会说的智能伙伴。

## 5.4 智能状态管理

为了摆脱传统遥控玩具"指令-动作"的单一模式,我们为机器狗设计了一套内部的、虚拟的"生理状态"系统,主要由"体力值(stamina)"和"开心值(happiness)"构成。这套系统使得机器狗的行为不再仅仅是对外部指令的被动响应,也受到其自身"生理状况"的影响。

"体力值"系统的设计理念源于对真实宠物的模仿。宠物会因为玩耍而疲劳,需要休息来恢复精力。stamina被设定为一个无符号整型变量,初始值为500,其上限也为500,下限为0。在主循环中每次执行耗费体力的动作(如前进、后退、转弯)后stamina值会相应减少,例如每执行一次前进循环stamina--。执行"睡觉"等休息性动作时stamina值会逐渐恢复,例如在mode_sleepwo()函数中每隔一段时间stamina++直到恢复到上限500。stamina值是行为决策的一个重要前置条件,在接收用户指令前程序会检查stamina,如果stamina<=0机器狗将进入"疲劳"状态执行mode_nanshou()(难受模式),表现为趴在地上一动不动并且忽略大部分运动指令。此时只有"睡觉"指令(move_mode=='2'或'p')才能被响应,让其进入恢复体力的状态。这套机制巧妙地引导用户需要"劳逸结合"地与机器狗互动,增加了养成的乐趣。

"开心值(happiness)"的设计更多是为未来的功能扩展做铺垫。在当前版本中它的初始值为200,但没有设计具体的增减和行为关联机制。在未来的版本中可以围绕"开心值"构建更丰富的情感交互模型:增加开心值,设计"抚摸"交互例如在机器狗背部安装触摸传感器,当用户抚摸时happiness++,同时机器狗会做出摇尾巴、蹭一蹭等积极反馈的动作;减少开心值,长时间不与机器狗互动或者粗暴地对待它(如通过陀螺仪检测到被踢或摔倒)happiness--;行为影响,当happiness值很高时机器狗可能会更活泼更愿意与用户互动甚至会主动做出一些"卖萌"的随机动作,当happiness值很低时它可能会表现得"郁郁寡欢"对指令的响应变得迟缓。

通过这套智能状态管理系统,机器狗的行为逻辑变得更加复杂和不可预测,从而更具"生命感",也为用户提供了更深层次的情感交互和养成体验。

## 5.5 OLED表情显示

视觉反馈是人机交互中最直观的一环。我们利用0.96英寸的OLED屏幕为机器狗设计了一双能够传情达意的"眼睛",极大地增强了其拟人化特征。

由于屏幕分辨率(128x64)和尺寸的限制,表情设计需要简洁且有代表性。我们使用PC端取模软件将设计好的眼部表情图案转换为十六进制的字模数组,每个字节代表8个像素点。例如我们设计了以下几种核心表情:立正(BMP1)一双圆睁的眼睛表示正常、警觉状态;睡觉(BMP2)眯成一条线的眼睛表示正在休息;难受(BMP3)带有"><"符号的眼睛表示疲劳或不适;爱心眼,眼睛变为心形用于表达开心或喜爱。这些字模数组被存储在OLED_Data.c文件中供OLED驱动函数调用。

我们封装了一个OLED_ShowImage(x, y, width, height, *BMP)函数,该函数可以将指定的BMP字模数组显示在屏幕的任意位置。在软件的顶层应用逻辑中我们将OLED表情的更新与机器狗的状态机紧密绑定。在处理move_mode的switch-case语句中,每个case(代表一种动作或状态)的末尾都会调用一次OLED_ShowImage()函数来切换到对应的表情。例如执行mode_forward()后调用OLED_ShowImage(BMP_Forward_Look),执行mode_sleepwo()后调用OLED_ShowImage(BMP_Sleeping),当stamina<=0时调用OLED_ShowImage(BMP_Dizzy)。通过这种方式,机器狗的"表情"能够实时、准确地反映其内部状态和正在执行的动作,为用户提供了一个清晰、直观的视觉反馈窗口,使得交互过程更加生动、有趣。

---

# 第六章 系统测试与分析

系统测试是验证设计方案、评估系统性能、确保产品质量的必要环节。在完成了四足机器狗的硬件搭建和软件编程后,我们进行了一系列严格的测试,涵盖了从单个硬件模块到软件功能,再到整机系统集成的各个层面。本章将详细介绍测试环境、测试方法、测试内容以及对测试结果的分析,旨在全面、客观地评估本设计的成果与不足。

## 6.1 硬件测试

硬件是系统稳定运行的基石。硬件测试的目标是确保每一个元器件、每一路电路都能正常工作,为上层软件的运行提供一个可靠的物理平台。测试环境使用数字万用表、示波器、直流稳压电源、逻辑分析仪等仪器,在实验室工作台进行测试。

电路板与电源测试包括空板测试,在焊接元器件之前使用万用表的通断档测试PCB板是否存在短路或断路,特别是电源和地之间;电源模块测试,将7.4V锂电池接入电源系统,使用万用表测量主板上各个关键节点的电压,重点测量为舵机供电的5V稳压输出和为STM32及逻辑电路供电的3.3V稳压输出是否准确、稳定;负载测试,将8个舵机全部接上并编写一个简单程序让其同时来回摆动模拟最大负载情况,使用示波器监测5V和3.3V电源轨的波形观察是否存在明显的电压跌落或纹波过大的情况。测试结果显示电路板无短路、断路现象,空载时5V和3.3V输出电压准确,在模拟最大负载下5V电源轨出现约150mV的瞬时电压跌落,3.3V电源轨波动小于50mV,均在允许范围内,表明电源系统设计合理带载能力满足要求。

舵机性能测试包括转角范围与精度测试,编写测试程序通过串口输入角度值(0-180度)驱动单个舵机转动,使用量角器测量舵机实际转动角度记录其与指令角度的误差;响应速度测试,向舵机发送一个从0度到180度的大幅度转动指令,使用秒表或高速摄像机记录其完成动作所需的时间;扭矩测试,在舵机摇臂上悬挂已知重量的砝码测试其在不同角度下的保持能力和堵转扭矩。测试结果显示SG90舵机的有效转角范围约为5-175度,在常用范围(30-150度)内角度误差小于3度满足本项目对精度的要求,从0度到180度的响应时间约为0.6秒,在4.8V电压下其堵转扭矩约为1.6kg·cm与标称值相符,足以驱动机器狗的腿部结构。

传感器精度测试中,超声波传感器测试将机器狗正对一个标准平板障碍物,分别在10cm、20cm、50cm、100cm的实际距离下连续读取10次传感器测量值计算平均值和误差,结果显示在1米范围内测量平均值与实际距离的误差小于2cm,但在10cm以内由于存在测量盲区误差增大,测试表明HC-SR04用于中远距离的障碍物预警是可靠的。红外传感器测试将机器狗放置在白色实验桌上缓慢推向桌子边缘,记录传感器输出电平跳变时传感器探头距离桌子边缘的实际距离,结果显示传感器在距离边缘约2-3cm时输出电平由低变高触发信号稳定可靠,该距离为机器狗提供了足够的反应时间来执行制动和后退动作满足防跌落设计要求。

通信模块测试包括蓝牙通信,使用手机APP与机器狗建立蓝牙连接测试连接稳定性,在不同距离(1m, 5m, 10m)下发送控制指令统计指令的响应成功率和延迟;语音识别,在安静环境下以正常语速和音量说出预设的10个指令词每个词重复10次统计识别成功率;语音合成,发送一段包含中文、英文和数字的文本测试SYN6288的合成效果。测试结果显示蓝牙在8米范围内连接稳定指令响应成功率接近100%延迟感不明显,语音识别在安静环境下识别率可达90%以上但在有噪音干扰时下降明显,语音合成清晰、自然,通信模块整体工作正常。

## 6.2 软件功能测试

软件功能测试旨在验证各个软件模块是否按照设计文档实现了预期的功能。

基本运动与姿态测试通过蓝牙或语音指令分别触发前进、后退、左转、右转、站立、坐下、趴下等动作观察机器狗的实际运动表现。测试标准为动作执行正确步态协调无明显卡顿或失衡姿态切换平滑。测试结果显示机器狗能够正确响应所有基本运动和姿态指令,前进和后退时步态稳定能够保持直线运动,左转和右转能够实现原地转向,站立、坐下、趴下等姿态切换连贯、自然,软件中的步态规划和舵机控制算法正确有效。

自主避障与防跌落测试包括避障测试,在地面设置不同大小的障碍物(如书本、水杯)开启避障模式控制机器狗前进观察其是否能够自主绕开障碍物;防跌落测试,将机器狗放置在实验桌上开启避障模式在桌面上遥控其向各个方向自由移动观察其是否会在到达边缘时自动停止并后退。测试结果显示在避障测试中机器狗能够可靠地探测到前方20cm范围内的障碍物并执行"后退-转向"的避障策略成功率约为85%(对于过窄或过低的障碍物有时会漏检),在防跌落测试中机器狗每次都能在到达桌面边缘时被红外传感器成功"拦截"无一次跌落发生,测试表明多传感器融合的避障和防跌落逻辑工作可靠。

状态管理系统测试连续控制机器狗执行前进、转弯等耗费体力的动作,同时通过串口打印stamina(体力值)变量观察其是否减少;待体力值耗尽后继续发送运动指令观察机器狗是否进入"难受"模式并拒绝执行;在"难受"模式下发送"睡觉"指令观察其是否执行睡觉动作并观察stamina值是否随时间恢复。测试结果显示体力值系统完全符合设计预期,stamina值会随着运动而消耗随休息而恢复,体力耗尽后机器狗的行为模式确实会发生改变,这套状态管理系统成功地为机器狗引入了"生理"特性增加了交互的趣味性。

## 6.3 系统集成测试

在完成单元模块和软件功能的独立测试后,需要进行整机集成测试,以评估系统在真实、复杂场景下的整体性能和稳定性。

整机联调与稳定性测试将机器狗组装完毕在办公室、家庭客厅等真实环境中长时间(如连续2小时)运行。在此期间综合使用蓝牙遥控、语音控制、自主避障等多种功能模拟正常用户的使用场景观察是否出现程序跑飞、死机、运动失调、部件松动等问题。测试结果显示在连续2小时的高强度混合测试中机器狗累计出现2次因舵机堵转导致单片机复位的情况,分析原因为舵机瞬时电流过大导致电源电压跌落。通过在软件中增加舵机堵转检测和保护机制(如检测到舵机长时间无法到达目标角度则降低其驱动电流)后问题得到改善。除此以外系统整体运行稳定未出现其他严重故障。

续航测试将两节满电的18650锂电池(单节容量2600mAh)装入机器狗,让机器狗持续执行"前进-左转-前进-右转"的循环动作模拟中等强度的运动,直至电池电压过低无法维持系统正常工作记录总运行时间。测试结果显示在中等强度运动模式下系统总续航时间约为75分钟,在待机或执行"睡觉"等低功耗动作时续航时间可大大延长,该续航水平对于一款桌面级交互式宠物机器人来说基本满足日常使用需求。

## 6.4 性能分析

通过对测试数据的量化分析,可以更客观地评价系统的各项性能指标。指令响应延迟从手机APP点击按钮到机器狗开始执行动作使用高速摄像机记录时间差,平均延迟约250ms,主要延迟来自蓝牙通信和软件处理,该延迟在人可接受范围内交互体验良好。运动精度命令机器狗前进1米使用卷尺测量实际前进距离重复10次,平均前进距离97.2cm(误差-2.8%),误差主要来自步态滑动和地面材质影响,对于非精确定位任务该精度可以接受。避障成功率在10次不同障碍物场景的避障测试中成功避开的次数为90%(9/10),对于正面标准障碍物成功率很高,对于侧面或不规则形状的障碍物存在失败风险。语音识别准确率在安静环境下对10个指令词每个说10遍统计正确识别次数为92%(92/100),离线识别模块性能满足基本交互需求但对发音标准和环境噪音敏感。

通过一系列系统、全面的测试,我们验证了"小呆"四足机器狗在硬件可靠性、软件功能完备性、整机稳定性和关键性能指标上均达到了设计目标。测试中也暴露了一些问题,如舵机堵转保护不足、复杂环境下避障能力有限等,这些都为我们下一阶段的优化工作指明了方向。

---

# 第七章 总结与展望

经过数月的紧张设计、开发与测试,基于STM32的智能四足机器狗"小呆"项目终于告一段落。本章将对整个毕业设计工作进行全面的总结,客观评价所取得的成果与存在的不足,并对该项目的未来发展方向和应用前景进行展望。

## 7.1 工作总结

本毕业设计成功地研制了一款功能全面、交互友好的桌面级智能四足机器狗。整个工作涵盖了从需求分析、方案设计、硬件选型、软件开发到系统测试的全过程,是一次完整的嵌入式系统项目实践。主要完成的工作及取得的成果总结如下。

首先完成了稳定可靠的硬件平台搭建。我们围绕STM32F103C8T6主控制器,成功地集成和调试了包括8路舵机驱动系统、超声波与红外传感器组成的感知系统、蓝牙与语音模块组成的通信系统以及OLED显示屏等硬件模块。通过合理的电路设计和电源管理,确保了硬件平台的稳定运行,为上层软件功能的实现提供了坚实的基础。

其次实现了平滑协调的运动控制。针对四足机器人的运动核心,我们设计并实现了一套基于对角步态的运动控制算法。通过引入基于时间分割的线性插值技术,有效地解决了多舵机同步与平滑过渡问题,使得机器狗能够完成前进、后退、转向等基本步态以及站立、坐下等姿态切换,动作连贯自然稳定性好。

第三构建了鲁棒有效的多传感器融合避障系统。本设计创新性地采用了一种基于行为分级的决策融合策略,将超声波传感器的远距离预警和红外传感器的近距离边缘检测相结合。该系统成功地赋予了机器狗在未知环境中自主避障和防跌落的能力,极大地提升了其智能性和环境适应性,测试成功率达到90%以上。

第四创建了丰富多样的立体化人机交互体系。我们突破了传统玩具单一的遥控模式,构建了一个包含蓝牙APP控制、离线语音指令、语音合成反馈和OLED表情显示的立体化交互体系。用户不仅可以精确控制机器狗的动作,还能通过"听"和"说"与其进行交流,并通过"眼睛"观察其状态,交互体验得到极大提升。

最后引入了新颖的智能状态管理系统。通过设计"体力值"这一内部虚拟状态,使机器狗的行为逻辑不再是简单的指令响应,而是与其自身的"生理状况"相关联。这一创新设计为机器狗注入了"生命感",增加了交互的趣味性和养成体验,是本项目在提升机器人"智能"和"情感"方面的一次有益探索。

总而言之,本项目不仅在技术上实现了预定的各项功能指标,更在设计理念上进行了积极的创新,成功地将一个传统的机器人控制项目拓展为一个兼具功能性、趣味性和情感交互的智能电子宠物设计。整个过程锻炼了我们在嵌入式系统开发、多学科知识综合运用以及解决复杂工程问题方面的能力。

## 7.2 存在的问题与不足

尽管本项目取得了预期的成果,但受限于时间、成本以及个人技术水平,系统中仍存在一些有待改进的问题和不足。

首先是运动控制较为初级。目前的步态规划采用的是预定义轨迹,对地形的适应性有限,仅能在平坦或微小起伏的地面上行走。系统没有引入IMU(惯性测量单元)等姿态传感器,缺乏闭环的姿态反馈和动态平衡调节能力,因此无法应对更复杂的地形或外部冲击。

其次是环境感知能力有限。当前的避障系统只能感知前方和底部的障碍物,缺乏对侧方和后方环境的感知,导致在复杂空间中转向或后退时仍有碰撞风险。此外仅依赖超声波和红外无法识别障碍物的类型(如台阶、玻璃等),智能性有待提高。

第三是语音交互体验有待提升。采用的离线语音识别模块虽然响应快,但指令词固定无法进行自然语言理解。在嘈杂环境下识别率下降明显影响了交互的流畅性。语音合成的声音也较为机械缺乏情感变化。

最后是机械结构有待优化。当前的3D打印结构件在长期使用后连接处可能会出现磨损和松动影响运动精度。舵机的扭矩对于某些高难度动作(如快速奔跑、跳跃)来说也略显不足。

## 7.3 未来展望

基于当前的工作基础和存在的不足,本项目在未来具有广阔的优化和扩展空间,可以从以下几个方面进行深入研究。

首先可以引入更高级的动态控制算法。未来的工作重心将是引入IMU传感器(如MPU6050)实时获取机身的俯仰、横滚和偏航角。通过建立机器人的动力学模型并结合PID控制或更高级的控制理论(如模型预测控制MPC),实现基于姿态反馈的闭环动态平衡控制。这将使机器狗能够在不平坦的地面上稳定行走甚至抵抗外部的推力。

其次可以构建更强大的环境感知系统。可以考虑引入视觉传感器如摄像头或激光雷达(LiDAR)。通过搭载轻量级的嵌入式AI处理器(如K210)运行SLAM(即时定位与地图构建)算法,使机器狗能够构建环境地图、自主导航和路径规划。结合图像识别算法还能让它识别特定的物体、人脸甚至理解手势指令。

第三可以升级到在线自然语言交互。将语音识别模块替换为能够连接云端AI平台的方案。通过Wi-Fi模块将采集到的语音数据上传至云端自然语言处理(NLP)服务(如科大讯飞、百度大脑等),实现对自然语言对话的理解并能进行多轮对话。这将使人机交互发生质的飞跃,让机器狗成为一个真正的智能会话伙伴。

最后可以探索更多应用场景。在现有平台的基础上可以通过加装不同的模块来拓展其应用领域。例如加装机械臂可以使其具备抓取物体的能力成为桌面助手;加装热成像摄像头可以用于设备巡检;通过编程还可以将其改造为一个新颖的、可实体化编程的教育平台,帮助青少年学习机器人和编程知识。

四足机器人的研究方兴未艾,它融合了机械、电子、控制与人工智能的精华,是通向未来智能机器人的重要途径。本毕业设计项目作为这一宏大领域中的一次微小探索,为我们打开了一扇通往未来科技的大门。我们相信,随着技术的不断进步,像"小呆"这样的智能机器伙伴必将走进千家万户,成为我们生活中不可或缺的一部分。

---

# 致谢

首先,我要向我的指导老师致以最诚挚的感谢。在整个毕业设计的过程中,从最初的课题选择、方案论证,到中期的技术攻关、代码调试,再到最终的论文撰写,您都给予了我悉心的指导和无私的帮助。您严谨的治学态度、深厚的专业知识和敏锐的洞察力,不仅为我指明了研究的方向,更教会了我如何科学地分析和解决问题。每当我遇到瓶颈和困惑时,您的耐心点拨和热情鼓励都给了我巨大的信心和动力。

感谢与我并肩作战的同学们和朋友们。在这段充满挑战和探索的旅程中,我们一起在实验室奋斗,交流技术难题,分享成功喜悦。你们的陪伴和支持,让这段紧张的时光充满了温暖和乐趣。

感谢学校为我们提供了优良的学习环境和实验条件,使得本项目的研究得以顺利进行。同时,我也要感谢网络上所有分享知识和经验的开源社区贡献者和技术博主,他们的无私分享为本项目的实现提供了宝贵的参考。

最后,我要感谢我的家人。他们是我最坚实的后盾,他们的理解、支持和关爱,是我能够心无旁骛、全力以赴完成学业和科研工作的源泉。

这段毕业设计的经历,不仅是对我大学四年所学知识的一次全面检验和升华,更是一次宝贵的科研实践锻炼。它将激励我在未来的学习和工作中,继续保持探索的热情,勇于面对挑战,不断前行。

---

# 参考文献

[1] Biswal, P., & Mohanty, P. K. (2021). Development of quadruped walking robots: A review. *Ain Shams Engineering Journal*, 12(3), 3233-3244. https://www.sciencedirect.com/science/article/pii/S2090447920302501

[2] Wu, D. (2024). Overview of the development history and current design status of quadrupedal animal robots. *Journal of Artificial Intelligence Practice*, 7(2), 1-8. http://166.62.7.99/assets/default/article/2024/07/14/article_1720943291.pdf

[3] Li, Q., Cicirelli, F., Vinci, A., Guerrieri, A., Qi, W., & Fortino, G. (2025). Quadruped Robots: Bridging Mechanical Design, Control, and Applications. *Robotics*, 14(5), 57. https://www.mdpi.com/2218-6581/14/5/57

[4] 王国彪, 陈殿生, 陈科位, 张自强. (2015). 仿生机器人研究现状与发展趋势. *机械工程学报*, 51(13), 27-44.

[5] Chai, H., et al. (2022). A survey of the development of quadruped robots: Joint configuration, gait planning and control. *Journal of Intelligent Manufacturing and Special Equipment*, 3(1), 1-28.

